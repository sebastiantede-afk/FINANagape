<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas Personales</title>
    
    <!-- Configuraci√≥n PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finanzas">
    
    <!-- Iconos para iOS (Opcional: Reemplazar href con tus propias im√°genes si las tienes) -->
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #111827;
            color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        .text-custom-income { color: #22d3ee; } /* Cyan m√°s brillante */
        .text-custom-expense { color: #f472b6; } /* Rosa m√°s suave */
        .card-bg { background-color: #1f2937; }
        
        /* Estilos de inputs mejorados para m√≥vil */
        .input-style {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #f3f4f6;
            font-size: 16px; /* Evita zoom en iOS */
        }
        .input-style:focus {
            border-color: #22d3ee;
            outline: none;
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
        }
        /* Ocultar barra de scroll en tablas pero permitir desplazamiento */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-900 pb-10">
    <div id="main-view" class="max-w-md mx-auto min-h-screen flex flex-col p-4 space-y-6">
        
        <!-- Header Compacto -->
        <header class="flex justify-between items-center py-2">
            <div>
                <h1 class="text-2xl font-bold text-gray-50">Mis Finanzas</h1>
                <p class="text-xs text-gray-400">Control de gastos e ingresos</p>
            </div>
            <div id="offline-indicator" class="hidden px-2 py-1 bg-red-900 text-red-200 text-xs rounded-full">
                Offline
            </div>
        </header>

        <!-- Botones de Acci√≥n R√°pida -->
        <div class="grid grid-cols-2 gap-3">
            <button id="show-queries-btn" class="bg-indigo-600 active:bg-indigo-700 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition-transform transform active:scale-95 text-sm">
                üîç Consultas
            </button>
            <button id="open-spreadsheet-btn" class="bg-emerald-600 active:bg-emerald-700 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition-transform transform active:scale-95 text-sm">
                üìä Ver Hoja
            </button>
        </div>

        <!-- Resumen Cards -->
        <div class="card-bg rounded-2xl shadow-xl p-5 border border-gray-700">
            <h2 class="text-sm font-medium text-gray-400 mb-4 uppercase tracking-wider text-center" id="resumen-periodo-titulo">Mes Actual</h2>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="p-2">
                    <p class="text-xs text-gray-400 mb-1">Ingresos</p>
                    <p id="total-ingresos" class="text-custom-income font-bold text-lg sm:text-xl">$0</p>
                </div>
                <div class="p-2 border-l border-r border-gray-700">
                    <p class="text-xs text-gray-400 mb-1">Gastos</p>
                    <p id="total-gastos" class="text-custom-expense font-bold text-lg sm:text-xl">$0</p>
                </div>
                <div class="p-2">
                    <p class="text-xs text-gray-400 mb-1">Balance</p>
                    <p id="diferencia" class="font-bold text-lg sm:text-xl">$0</p>
                </div>
            </div>

            <!-- Filtros de fecha colapsables -->
            <details class="mt-4">
                <summary class="text-xs text-center text-gray-500 cursor-pointer hover:text-gray-300">Filtrar por fechas</summary>
                <div class="mt-3 flex gap-2">
                    <input type="date" id="fecha-inicio" class="w-1/2 rounded-lg p-2 input-style text-xs">
                    <input type="date" id="fecha-final" class="w-1/2 rounded-lg p-2 input-style text-xs">
                </div>
                <button id="reset-dates-btn" class="mt-2 w-full py-1 text-xs text-blue-400 hover:text-blue-300">Ver mes actual</button>
            </details>
        </div>

        <!-- Formulario de Transacci√≥n -->
        <div class="card-bg rounded-2xl shadow-xl p-5 border border-gray-700">
            <h2 class="text-lg font-semibold text-gray-100 mb-4 flex items-center">
                <span class="bg-blue-600 w-1 h-6 mr-2 rounded-full"></span>
                Nueva Transacci√≥n
            </h2>
            <form id="transaction-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="fecha" required class="w-full rounded-lg p-3 input-style">
                    <select id="concepto" required class="w-full rounded-lg p-3 input-style">
                        <option value="Gasto" selected>üî¥ Gasto</option>
                        <option value="Ingreso">üü¢ Ingreso</option>
                    </select>
                </div>
                
                <input type="number" id="cantidad" placeholder="$0.00" step="0.01" required class="w-full rounded-lg p-3 input-style text-xl font-bold text-center">

                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="referencia" placeholder="Ref (Ej. Super)" required class="w-full rounded-lg p-3 input-style">
                    <select id="tipoMovimiento" required class="w-full rounded-lg p-3 input-style">
                        <option value="Efectivo">üíµ Efectivo</option>
                        <option value="Tarjeta">üí≥ Cr√©dito</option>
                        <option value="Debito">üí≥ D√©bito</option>
                        <option value="Transferencia">üè¶ Transf.</option>
                    </select>
                </div>
                
                <input type="text" id="descripcion" placeholder="Detalle opcional..." class="w-full rounded-lg p-3 input-style">

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-colors flex justify-center items-center gap-2">
                    <span>Guardar</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                </button>
            </form>
        </div>

        <!-- Lista de Movimientos -->
        <div class="space-y-4">
            <h2 class="text-lg font-semibold text-gray-200 px-2">√öltimos Movimientos</h2>
            <div id="transactions-list" class="space-y-3">
                <!-- Las tarjetas se generan con JS -->
            </div>
        </div>

        <!-- Resumen Mensual -->
        <div class="card-bg rounded-2xl shadow-xl p-5 border border-gray-700">
            <h2 class="text-lg font-semibold text-gray-100 mb-4">Hist√≥rico Mensual</h2>
            <div class="overflow-x-auto no-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs text-gray-500 border-b border-gray-700">
                            <th class="pb-2 pl-2">Mes</th>
                            <th class="pb-2 text-right">Ingresos</th>
                            <th class="pb-2 pr-2 text-right">Gastos</th>
                        </tr>
                    </thead>
                    <tbody id="resumen-mensual" class="text-sm"></tbody>
                </table>
            </div>
        </div>

        <div class="text-center text-xs text-gray-600 pt-8 pb-4">
            App de Finanzas v2.0
        </div>
    </div>

    <!-- Vista de Consultas (Hidden por defecto) -->
    <div id="queries-view" class="fixed inset-0 bg-gray-900 z-50 overflow-y-auto hidden p-4">
        <div class="max-w-md mx-auto space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white">Consultas</h2>
                <button id="show-main-btn" class="bg-gray-700 p-2 rounded-full text-white">‚úï</button>
            </div>
            
            <div class="card-bg rounded-2xl p-5 border border-gray-700">
                <p class="text-sm text-gray-400 mb-4">Compara referencias (Ej: "Ahorro" vs "Gastos")</p>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-custom-income block mb-1">Referencia Ingreso</label>
                        <input type="text" id="income-reference" class="w-full rounded-lg p-3 input-style">
                    </div>
                    <div>
                        <label class="text-xs text-custom-expense block mb-1">Referencia Gasto</label>
                        <input type="text" id="expense-reference" class="w-full rounded-lg p-3 input-style">
                    </div>
                </div>
                <div class="mt-6 text-center p-4 bg-gray-800 rounded-xl">
                    <span class="text-gray-400 text-sm">Balance</span>
                    <p id="balance-result" class="text-2xl font-bold text-white mt-1">$0.00</p>
                </div>
            </div>

            <div id="results-table-container" class="hidden pb-10">
                <h3 class="text-lg font-semibold text-gray-200 mb-3">Detalle</h3>
                <div id="results-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        // URL de tu Google Apps Script
        const googleAppsScriptURL = "https://script.google.com/macros/s/AKfycbyxiOeiLahcOp54Uhnk2XitJF61jNOkIGx0YrjAwholiYt0ZB48S46PVz6wahr0TFVNBg/exec";

        // Elementos DOM
        const form = document.getElementById('transaction-form');
        const transactionsList = document.getElementById('transactions-list');
        const totalIngresosEl = document.getElementById('total-ingresos');
        const totalGastosEl = document.getElementById('total-gastos');
        const diferenciaEl = document.getElementById('diferencia');
        const fechaInicioInput = document.getElementById('fecha-inicio');
        const fechaFinalInput = document.getElementById('fecha-final');
        const resumenMensualTable = document.getElementById('resumen-mensual');
        const openSpreadsheetBtn = document.getElementById('open-spreadsheet-btn');
        const resumenPeriodoTitulo = document.getElementById('resumen-periodo-titulo');
        const resetDatesBtn = document.getElementById('reset-dates-btn');
        
        // Vistas
        const mainView = document.getElementById('main-view');
        const queriesView = document.getElementById('queries-view');
        const showQueriesBtn = document.getElementById('show-queries-btn');
        const showMainBtn = document.getElementById('show-main-btn');
        const incomeRefInput = document.getElementById('income-reference');
        const expenseRefInput = document.getElementById('expense-reference');
        const balanceResultEl = document.getElementById('balance-result');
        const resultsTableContainer = document.getElementById('results-table-container');
        const resultsList = document.getElementById('results-list');

        let transactions = [];
        const meses = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

        // Configurar fecha de hoy por defecto
        document.getElementById('fecha').valueAsDate = new Date();

        function loadTransactions() {
            const stored = localStorage.getItem('Transacciones');
            if (stored) transactions = JSON.parse(stored);
        }

        function saveTransactions() {
            localStorage.setItem('Transacciones', JSON.stringify(transactions));
        }

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(amount);
        }

        function renderTransactions() {
            transactionsList.innerHTML = '';
            const sorted = [...transactions].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            sorted.slice(0, 15).forEach(t => {
                const isIncome = t.concepto === 'Ingreso';
                const colorClass = isIncome ? 'text-custom-income' : 'text-custom-expense';
                const sign = isIncome ? '+' : '-';
                const icon = t.tipoMovimiento === 'Efectivo' ? 'üíµ' : t.tipoMovimiento === 'Tarjeta' ? 'üí≥' : 'üè¶';

                const div = document.createElement('div');
                div.className = "card-bg p-4 rounded-xl border border-gray-700 flex justify-between items-center shadow-sm";
                div.innerHTML = `
                    <div class="flex flex-col overflow-hidden">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${icon}</span>
                            <span class="font-bold text-gray-200 truncate">${t.referencia}</span>
                        </div>
                        <span class="text-xs text-gray-500 mt-1">${new Date(t.fecha).toLocaleDateString()} ‚Ä¢ ${t.descripcion || '-'}</span>
                    </div>
                    <div class="flex flex-col items-end pl-2 min-w-max">
                        <span class="${colorClass} font-bold text-lg">${sign}${formatCurrency(t.cantidad)}</span>
                        <button onclick="deleteTransaction(${t.id})" class="text-xs text-red-400 mt-1 py-1 px-2 hover:bg-red-900/30 rounded">Eliminar</button>
                    </div>
                `;
                transactionsList.appendChild(div);
            });
        }

        function deleteTransaction(id) {
            if(confirm('¬øBorrar esta transacci√≥n?')) {
                // CORRECCI√ìN IMPORTANTE: Borrar por ID √∫nico, no por √≠ndice
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateUI();
            }
        }

        function updateUI() {
            renderTransactions();
            updateSummary();
            renderMonthlySummary();
        }

        function updateSummary() {
            let start = fechaInicioInput.value;
            let end = fechaFinalInput.value;
            let label = "Mes Actual";

            if (!start && !end) {
                const date = new Date();
                const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
                const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                start = firstDay.toISOString().split('T')[0];
                end = lastDay.toISOString().split('T')[0];
                label = `${meses[date.getMonth()]} ${date.getFullYear()}`;
            }

            resumenPeriodoTitulo.textContent = label;

            const filtered = transactions.filter(t => {
                // Arreglo zona horaria simple comparando strings YYYY-MM-DD
                return (!start || t.fecha >= start) && (!end || t.fecha <= end);
            });

            const ingresos = filtered.filter(t => t.concepto === 'Ingreso').reduce((acc, t) => acc + t.cantidad, 0);
            const gastos = filtered.filter(t => t.concepto === 'Gasto').reduce((acc, t) => acc + t.cantidad, 0);
            const diff = ingresos - gastos;

            totalIngresosEl.textContent = formatCurrency(ingresos);
            totalGastosEl.textContent = formatCurrency(gastos);
            diferenciaEl.textContent = formatCurrency(diff);
            diferenciaEl.className = `font-bold text-lg sm:text-xl ${diff >= 0 ? 'text-custom-income' : 'text-custom-expense'}`;
        }

        function renderMonthlySummary() {
            resumenMensualTable.innerHTML = '';
            const data = {};

            transactions.forEach(t => {
                const k = t.fecha.substring(0, 7); // YYYY-MM
                if (!data[k]) data[k] = { in: 0, out: 0 };
                if (t.concepto === 'Ingreso') data[k].in += t.cantidad;
                else data[k].out += t.cantidad;
            });

            Object.keys(data).sort().reverse().forEach(key => {
                const [y, m] = key.split('-');
                const row = document.createElement('tr');
                row.className = "border-b border-gray-800 hover:bg-gray-800 transition-colors";
                row.innerHTML = `
                    <td class="py-3 pl-2 text-gray-300 font-medium">${meses[parseInt(m)-1]} ${y}</td>
                    <td class="py-3 text-right text-custom-income">${formatCurrency(data[key].in)}</td>
                    <td class="py-3 pr-2 text-right text-custom-expense">${formatCurrency(data[key].out)}</td>
                `;
                resumenMensualTable.appendChild(row);
            });
        }

        // Env√≠o a Apps Script
        async function saveToCloud(t) {
            if (googleAppsScriptURL.includes("AQUI_DEBE_IR")) return;
            
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin">‚Üª</span> Guardando...`;
            
            try {
                const fd = new FormData();
                // Mapear a los nombres que espera tu script
                fd.append('FECHA', t.fecha);
                fd.append('CONCEPTO', t.concepto);
                fd.append('REFERENCIA', t.referencia);
                fd.append('CANTIDAD', t.cantidad);
                fd.append('DESCRIPCION', t.descripcion);
                fd.append('TIPO_MOVIMIENTO', t.tipoMovimiento);
                
                await fetch(googleAppsScriptURL, { method: 'POST', body: fd, mode: 'no-cors' }); // no-cors para evitar errores simples de red en fetch simple
                
                // Nota: Con no-cors no podemos saber si fall√≥ realmente, pero asumimos √©xito si no hay error de red
                showToast("Guardado en la nube ‚úÖ");
            } catch (e) {
                showToast("Guardado local (Error nube) ‚ö†Ô∏è");
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        function showToast(msg) {
            const div = document.createElement('div');
            div.className = "fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg border border-gray-600 text-sm animate-bounce";
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Listeners
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const rawDate = document.getElementById('fecha').value;
            const t = {
                id: Date.now(), // ID √öNICO
                fecha: rawDate,
                concepto: document.getElementById('concepto').value,
                referencia: document.getElementById('referencia').value,
                tipoMovimiento: document.getElementById('tipoMovimiento').value,
                descripcion: document.getElementById('descripcion').value,
                cantidad: parseFloat(document.getElementById('cantidad').value)
            };
            
            transactions.push(t);
            saveTransactions();
            updateUI();
            form.reset();
            document.getElementById('fecha').value = rawDate; // Mantener fecha
            
            saveToCloud(t);
        });

        openSpreadsheetBtn.onclick = () => window.open(googleAppsScriptURL, '_blank');
        
        // Consultas
        showQueriesBtn.onclick = () => { mainView.classList.add('hidden'); queriesView.classList.remove('hidden'); };
        showMainBtn.onclick = () => { queriesView.classList.add('hidden'); mainView.classList.remove('hidden'); };
        
        function updateQueries() {
            const incRef = incomeRefInput.value.trim().toUpperCase();
            const expRef = expenseRefInput.value.trim().toUpperCase();
            
            if(!incRef && !expRef) {
                balanceResultEl.textContent = "$0.00";
                resultsTableContainer.classList.add('hidden');
                return;
            }

            const match = transactions.filter(t => {
                if(t.concepto === 'Ingreso' && incRef && t.referencia.toUpperCase().includes(incRef)) return true;
                if(t.concepto === 'Gasto' && expRef && t.referencia.toUpperCase().includes(expRef)) return true;
                return false;
            });

            const sumIn = match.filter(t => t.concepto === 'Ingreso').reduce((a,b)=>a+b.cantidad,0);
            const sumOut = match.filter(t => t.concepto === 'Gasto').reduce((a,b)=>a+b.cantidad,0);
            const bal = sumIn - sumOut;

            balanceResultEl.textContent = formatCurrency(bal);
            balanceResultEl.className = `text-2xl font-bold mt-1 ${bal >= 0 ? 'text-custom-income' : 'text-custom-expense'}`;
            
            resultsList.innerHTML = '';
            if(match.length > 0) {
                resultsTableContainer.classList.remove('hidden');
                match.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).forEach(t => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between text-sm p-2 bg-gray-800 rounded border border-gray-700";
                    div.innerHTML = `<span>${t.fecha} ${t.referencia}</span><span class="${t.concepto === 'Ingreso'?'text-custom-income':'text-custom-expense'}">${formatCurrency(t.cantidad)}</span>`;
                    resultsList.appendChild(div);
                });
            }
        }

        incomeRefInput.oninput = updateQueries;
        expenseRefInput.oninput = updateQueries;

        fechaInicioInput.onchange = updateSummary;
        fechaFinalInput.onchange = updateSummary;
        resetDatesBtn.onclick = () => { fechaInicioInput.value = ''; fechaFinalInput.value = ''; updateSummary(); };

        // Init
        window.onload = () => {
            loadTransactions();
            updateUI();
            
            // Registrar Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(() => console.log('SW Listo'))
                    .catch(err => console.log('SW Error', err));
            }
            
            // Detectar conexi√≥n
            window.addEventListener('online', () => document.getElementById('offline-indicator').classList.add('hidden'));
            window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('hidden'));
        };
    </script>
</body>
</html>