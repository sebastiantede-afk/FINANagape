<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Gastos e Ingresos | App PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Finanzas App">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Colores Originales: Negro, Azul El茅ctrico, Rosa Fuerte */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .text-custom-income { color: #00BFFF; } /* Azul El茅ctrico */
        .text-custom-expense { color: #FF007F; } /* Rosa Fuerte */
        .card-bg { background-color: #1F2937; }
        .input-dark {
            background-color: #374151;
            border: 1px solid #4B5563;
            color: #ffffff;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- VISTA PRINCIPAL -->
    <div id="main-view" class="max-w-4xl mx-auto space-y-6">
        <h1 class="text-3xl font-bold text-center mb-8">Gestor de Finanzas</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button id="show-queries-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                Consultas Especiales
            </button>
            <button id="open-spreadsheet-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                Abrir Planilla Google
            </button>
        </div>

        <!-- Formulario Registro -->
        <div class="card-bg p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4">Nueva Transacci贸n</h2>
            <form id="transaction-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="fecha" required class="p-2 rounded input-dark">
                    <select id="concepto" required class="p-2 rounded input-dark">
                        <option value="Ingreso">Ingreso (+)</option>
                        <option value="Gasto">Gasto (-)</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="referencia" placeholder="Referencia" required class="p-2 rounded input-dark">
                    <select id="tipoMovimiento" required class="p-2 rounded input-dark">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Tarjeta">Tarjeta de Cr茅dito</option>
                        <option value="Debito">Tarjeta de D茅bito</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <input type="text" id="descripcion" placeholder="Descripci贸n" required class="w-full p-2 rounded input-dark">
                <input type="number" id="cantidad" placeholder="Monto ($)" step="0.01" required class="w-full p-2 rounded input-dark text-lg font-bold">
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg transition-colors">
                    Guardar Movimiento
                </button>
            </form>
        </div>

        <!-- Resumen General con Filtros -->
        <div class="card-bg p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4" id="resumen-titulo">Resumen del Periodo</h2>
            
            <!-- Buscador por Referencia -->
            <div class="mb-4">
                <input type="text" id="filtro-referencia" placeholder=" Filtrar por referencia (Ej: Sueldo, Super...)" class="w-full p-2 rounded input-dark text-sm">
            </div>

            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="p-2 border border-gray-700 rounded">
                    <p class="text-xs text-gray-400">INGRESOS</p>
                    <p id="total-ingresos" class="text-custom-income font-bold">$0.00</p>
                </div>
                <div class="p-2 border border-gray-700 rounded">
                    <p class="text-xs text-gray-400">GASTOS</p>
                    <p id="total-gastos" class="text-custom-expense font-bold">$0.00</p>
                </div>
                <div class="p-2 border border-gray-700 rounded">
                    <p class="text-xs text-gray-400">BALANCE</p>
                    <p id="diferencia" class="font-bold">$0.00</p>
                </div>
            </div>
            
            <div class="mt-4 grid grid-cols-2 gap-4">
                <input type="date" id="fecha-inicio" class="p-2 text-xs rounded input-dark">
                <input type="date" id="fecha-final" class="p-2 text-xs rounded input-dark">
            </div>
            <button id="reset-dates-btn" class="mt-2 w-full text-xs text-gray-400 underline">Limpiar todos los filtros</button>
        </div>

        <!-- ESTADSTICAS MENSUALES -->
        <div class="card-bg p-6 rounded-xl shadow-lg overflow-hidden">
            <h2 class="text-xl font-bold mb-4">Estad铆sticas por Mes</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-gray-700 text-gray-400 text-sm">
                            <th class="py-2">Mes</th>
                            <th class="py-2 text-custom-income">Ingresos</th>
                            <th class="py-2 text-custom-expense">Gastos</th>
                            <th class="py-2">Neto</th>
                        </tr>
                    </thead>
                    <tbody id="monthly-summary-table" class="text-sm">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Historial -->
        <div class="card-bg rounded-xl shadow-lg overflow-hidden">
            <h2 class="p-6 text-xl font-bold border-b border-gray-700">Historial Reciente</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-800 text-xs text-gray-400 uppercase">
                        <tr>
                            <th class="px-4 py-3">Fecha</th>
                            <th class="px-4 py-3">Ref</th>
                            <th class="px-4 py-3">Monto</th>
                            <th class="px-4 py-3 text-center">Acci贸n</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table" class="divide-y divide-gray-700">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VISTA CONSULTAS -->
    <div id="queries-view" class="max-w-4xl mx-auto space-y-6 hidden">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold">Consultas Especiales</h1>
            <button id="show-main-btn" class="bg-gray-600 px-4 py-2 rounded">Volver</button>
        </div>

        <div class="card-bg p-6 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="income-reference" placeholder="Ingreso por Referencia..." class="p-3 rounded input-dark">
                <input type="text" id="expense-reference" placeholder="Gasto por Referencia..." class="p-3 rounded input-dark">
            </div>
            <div class="mt-6 p-4 bg-black/30 rounded text-center">
                <p class="text-sm text-gray-400">Balance de B煤squeda</p>
                <p id="balance-result" class="text-3xl font-bold mt-1">$0.00</p>
            </div>
        </div>

        <div id="results-table-container" class="card-bg rounded-xl overflow-hidden hidden">
            <table class="w-full text-sm">
                <thead class="bg-gray-800 text-gray-400">
                    <tr>
                        <th class="px-4 py-2">Fecha</th>
                        <th class="px-4 py-2">Ref</th>
                        <th class="px-4 py-2">Monto</th>
                    </tr>
                </thead>
                <tbody id="results-table" class="divide-y divide-gray-700"></tbody>
            </table>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxm-ykWsDdqHTzJW0OfjVAnROD-nTL0nhOyJc3xlelss8HzQuw0d2zIJKOw4XiUFDcQ9A/exec";
        let transactions = [];
        const fmt = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' });

        // Elementos
        const txForm = document.getElementById('transaction-form');
        const txTable = document.getElementById('transactions-table');
        const monthTable = document.getElementById('monthly-summary-table');
        const refFilterInput = document.getElementById('filtro-referencia');

        function loadData() {
            const saved = localStorage.getItem('finanzas_v1');
            if (saved) transactions = JSON.parse(saved);
        }

        function saveData() {
            localStorage.setItem('finanzas_v1', JSON.stringify(transactions));
        }

        function renderAll() {
            renderMainTable();
            renderMonthlyStats();
            updateSummary();
        }

        function renderMainTable() {
            txTable.innerHTML = '';
            const copy = [...transactions].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            copy.slice(0, 20).forEach((t, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${t.fecha.split('-').reverse().join('/')}</td>
                    <td class="px-4 py-3 text-sm text-gray-300">${t.referencia}</td>
                    <td class="px-4 py-3 text-sm font-bold ${t.concepto === 'Ingreso' ? 'text-custom-income' : 'text-custom-expense'}">
                        ${fmt.format(t.cantidad)}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteTx(${transactions.indexOf(t)})" class="text-gray-500 hover:text-red-500">Eliminar</button>
                    </td>
                `;
                txTable.appendChild(row);
            });
        }

        function renderMonthlyStats() {
            monthTable.innerHTML = '';
            const stats = {};
            transactions.forEach(t => {
                const mes = t.fecha.substring(0, 7);
                if (!stats[mes]) stats[mes] = { in: 0, out: 0 };
                if (t.concepto === 'Ingreso') stats[mes].in += Number(t.cantidad);
                else stats[mes].out += Number(t.cantidad);
            });

            Object.keys(stats).sort().reverse().forEach(mes => {
                const net = stats[mes].in - stats[mes].out;
                const row = document.createElement('tr');
                row.className = "border-b border-gray-800";
                row.innerHTML = `
                    <td class="py-3 font-medium">${mes}</td>
                    <td class="py-3 text-custom-income">${fmt.format(stats[mes].in)}</td>
                    <td class="py-3 text-custom-expense">${fmt.format(stats[mes].out)}</td>
                    <td class="py-3 font-bold ${net >= 0 ? 'text-green-400' : 'text-red-400'}">${fmt.format(net)}</td>
                `;
                monthTable.appendChild(row);
            });
        }

        function updateSummary() {
            const fIn = document.getElementById('fecha-inicio').value;
            const fFi = document.getElementById('fecha-final').value;
            const refFiltro = refFilterInput.value.toLowerCase().trim();
            
            let filtered = transactions;
            
            if (fIn && fFi) {
                filtered = filtered.filter(t => t.fecha >= fIn && t.fecha <= fFi);
                document.getElementById('resumen-titulo').innerText = "Resumen Filtrado";
            } else {
                document.getElementById('resumen-titulo').innerText = "Resumen Hist贸rico";
            }

            if (refFiltro) {
                filtered = filtered.filter(t => t.referencia.toLowerCase().includes(refFiltro));
            }

            const ingresos = filtered.filter(t => t.concepto === 'Ingreso').reduce((a, b) => a + Number(b.cantidad), 0);
            const gastos = filtered.filter(t => t.concepto === 'Gasto').reduce((a, b) => a + Number(b.cantidad), 0);
            
            document.getElementById('total-ingresos').innerText = fmt.format(ingresos);
            document.getElementById('total-gastos').innerText = fmt.format(gastos);
            const diff = ingresos - gastos;
            const diffEl = document.getElementById('diferencia');
            diffEl.innerText = fmt.format(diff);
            diffEl.className = `font-bold ${diff >= 0 ? 'text-custom-income' : 'text-custom-expense'}`;
        }

        window.deleteTx = (idx) => {
            transactions.splice(idx, 1);
            saveData();
            renderAll();
        };

        txForm.onsubmit = async (e) => {
            e.preventDefault();
            const tx = {
                fecha: document.getElementById('fecha').value,
                concepto: document.getElementById('concepto').value,
                referencia: document.getElementById('referencia').value,
                tipoMovimiento: document.getElementById('tipoMovimiento').value,
                descripcion: document.getElementById('descripcion').value,
                cantidad: document.getElementById('cantidad').value
            };
            
            transactions.push(tx);
            saveData();
            renderAll();
            txForm.reset();
            document.getElementById('fecha').valueAsDate = new Date();

            try {
                const params = new URLSearchParams();
                for(let key in tx) params.append(key.toUpperCase(), tx[key]);
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: params });
            } catch(e) {}
        };

        document.getElementById('show-queries-btn').onclick = () => {
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('queries-view').classList.remove('hidden');
        };
        document.getElementById('show-main-btn').onclick = () => {
            document.getElementById('queries-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
        };
        document.getElementById('reset-dates-btn').onclick = () => {
            document.getElementById('fecha-inicio').value = '';
            document.getElementById('fecha-final').value = '';
            refFilterInput.value = '';
            updateSummary();
        };

        document.getElementById('fecha-inicio').onchange = updateSummary;
        document.getElementById('fecha-final').onchange = updateSummary;
        refFilterInput.oninput = updateSummary;

        function runQuery() {
            const inc = document.getElementById('income-reference').value.toLowerCase();
            const exp = document.getElementById('expense-reference').value.toLowerCase();
            const resTable = document.getElementById('results-table');
            const container = document.getElementById('results-table-container');

            if (!inc && !exp) { container.classList.add('hidden'); return; }

            const filtered = transactions.filter(t => {
                const ref = t.referencia.toLowerCase();
                return (t.concepto === 'Ingreso' && ref.includes(inc) && inc !== '') || 
                       (t.concepto === 'Gasto' && ref.includes(exp) && exp !== '');
            });

            resTable.innerHTML = '';
            let b = 0;
            filtered.forEach(t => {
                const val = Number(t.cantidad);
                b += (t.concepto === 'Ingreso' ? val : -val);
                const r = document.createElement('tr');
                r.innerHTML = `<td class="px-4 py-2">${t.fecha}</td><td class="px-4 py-2">${t.referencia}</td><td class="px-4 py-2 ${t.concepto === 'Ingreso' ? 'text-custom-income' : 'text-custom-expense'}">${fmt.format(val)}</td>`;
                resTable.appendChild(r);
            });

            const resEl = document.getElementById('balance-result');
            resEl.innerText = fmt.format(b);
            resEl.className = `text-3xl font-bold mt-1 ${b >= 0 ? 'text-custom-income' : 'text-custom-expense'}`;
            container.classList.remove('hidden');
        }

        document.getElementById('income-reference').oninput = runQuery;
        document.getElementById('expense-reference').oninput = runQuery;
        document.getElementById('open-spreadsheet-btn').onclick = () => window.open("https://docs.google.com/spreadsheets/", "_blank");

        window.onload = () => {
            loadData();
            document.getElementById('fecha').valueAsDate = new Date();
            renderAll();
        };
    </script>
</body>
</html>
