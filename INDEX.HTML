<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas Sheets Pro + Stats</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #111827;
            color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        .text-custom-income { color: #22d3ee; } 
        .text-custom-expense { color: #f472b6; }
        .card-bg { background-color: #1f2937; }
        
        .input-style {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #f3f4f6;
            font-size: 16px;
        }
        .input-style:focus {
            border-color: #22d3ee;
            outline: none;
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tab-active {
            border-bottom: 3px solid #10b981;
            color: #10b981;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 pb-24">
    
    <!-- Header Fijo -->
    <header class="max-w-md mx-auto p-4 flex justify-between items-center sticky top-0 bg-gray-900 z-40 border-b border-gray-800">
        <div>
            <h1 class="text-xl font-bold text-gray-50">Finanzas Pro</h1>
            <p id="status-text" class="text-[10px] text-emerald-400 flex items-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                Sincronizaci√≥n Activa
            </p>
        </div>
        <div id="loading-indicator" class="hidden"><div class="spinner"></div></div>
    </header>

    <!-- Contenedor Principal -->
    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- VISTA: REGISTRO -->
        <div id="view-register" class="space-y-6">
            <!-- Balance R√°pido -->
            <div class="card-bg rounded-2xl shadow-xl p-5 border border-gray-700">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase">Ingresos</p>
                        <p id="total-ingresos" class="text-custom-income font-bold text-lg">$0</p>
                    </div>
                    <div class="border-l border-r border-gray-700">
                        <p class="text-[10px] text-gray-400 uppercase">Gastos</p>
                        <p id="total-gastos" class="text-custom-expense font-bold text-lg">$0</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase">Balance</p>
                        <p id="diferencia" class="font-bold text-lg">$0</p>
                    </div>
                </div>
            </div>

            <!-- Formulario -->
            <div class="card-bg rounded-2xl shadow-xl p-5 border border-gray-700">
                <form id="transaction-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="fecha" required class="w-full rounded-lg p-3 input-style">
                        <select id="concepto" required class="w-full rounded-lg p-3 input-style">
                            <option value="Gasto">üî¥ Gasto</option>
                            <option value="Ingreso">üü¢ Ingreso</option>
                        </select>
                    </div>
                    
                    <input type="number" id="cantidad" placeholder="0.00" step="0.01" required class="w-full rounded-lg p-3 input-style text-xl font-bold text-center">

                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="referencia" placeholder="Ref (Ej. Super)" required class="w-full rounded-lg p-3 input-style">
                        <select id="tipoMovimiento" required class="w-full rounded-lg p-3 input-style">
                            <option value="Efectivo">üíµ Efectivo</option>
                            <option value="Tarjeta">üí≥ Tarjeta</option>
                            <option value="Transferencia">üè¶ Transf.</option>
                        </select>
                    </div>
                    
                    <input type="text" id="descripcion" placeholder="Nota extra..." class="w-full rounded-lg p-3 input-style">

                    <button type="submit" id="submit-btn" class="w-full bg-emerald-600 active:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 transition-all">
                        <span>Guardar en Planilla</span>
                    </button>
                </form>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-sm font-semibold text-gray-400 uppercase">√öltimos movimientos</h2>
                    <button onclick="clearAll()" class="text-[10px] text-red-400 hover:text-red-300 uppercase font-bold">Limpiar Local</button>
                </div>
                <div id="transactions-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- VISTA: ESTAD√çSTICAS -->
        <div id="view-stats" class="hidden space-y-6 animate-fadeIn">
            <!-- Filtros Avanzados -->
            <div class="card-bg rounded-2xl shadow-xl p-5 border border-gray-700 space-y-4">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                    <h2 class="text-sm font-bold text-gray-300 uppercase tracking-tighter">Filtros de An√°lisis</h2>
                    <span class="text-[10px] text-emerald-400 font-bold uppercase" id="stats-range-label">Personalizado</span>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">Desde</label>
                        <input type="date" id="stats-desde" onchange="calculateStats()" class="w-full rounded-lg p-2 input-style text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">Hasta</label>
                        <input type="date" id="stats-hasta" onchange="calculateStats()" class="w-full rounded-lg p-2 input-style text-sm">
                    </div>
                </div>

                <!-- FILTRO POR REFERENCIA (NUEVO) -->
                <div>
                    <label class="text-[10px] text-gray-500 block mb-1">Filtrar por Referencia</label>
                    <select id="filter-ref" onchange="calculateStats()" class="w-full rounded-lg p-2 input-style text-sm">
                        <option value="TODAS">üîç Todas las referencias</option>
                    </select>
                </div>
            </div>

            <!-- RESUMEN DE BALANCE -->
            <div id="stats-hero" class="space-y-4">
                <!-- Tarjeta de Balance Neto -->
                <div id="net-card" class="p-6 rounded-2xl border flex flex-col items-center justify-center space-y-2 transition-all duration-500 shadow-lg">
                    <p class="text-xs uppercase tracking-widest font-bold opacity-70" id="net-label">Balance Neto</p>
                    <p class="text-4xl font-black" id="net-amount">$0</p>
                    <div id="net-indicator" class="text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-widest"></div>
                </div>

                <!-- Comparativa Visual R√°pida -->
                <div class="card-bg p-5 rounded-2xl border border-gray-700 space-y-4">
                    <div class="flex justify-between text-[10px] font-black uppercase tracking-widest">
                        <span class="text-custom-income">Ingresos</span>
                        <span class="text-custom-expense">Gastos</span>
                    </div>
                    <!-- Barra de balance porcentual -->
                    <div class="w-full h-3 bg-gray-800 rounded-full flex overflow-hidden border border-gray-900 shadow-inner">
                        <div id="bar-inc" class="bg-cyan-500 h-full transition-all duration-1000 border-r border-gray-900"></div>
                        <div id="bar-exp" class="bg-pink-500 h-full transition-all duration-1000"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-left border-l-2 border-cyan-500 pl-2">
                            <p class="text-lg font-black text-custom-income" id="hero-inc">$0</p>
                            <p class="text-[9px] text-gray-500 uppercase font-bold">Total periodo</p>
                        </div>
                        <div class="text-right border-r-2 border-pink-500 pr-2">
                            <p class="text-lg font-black text-custom-expense" id="hero-exp">$0</p>
                            <p class="text-[9px] text-gray-500 uppercase font-bold">Total periodo</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPARATIVA POR REFERENCIA (Solo se muestra si el filtro es 'TODAS') -->
            <div id="ref-comparative-section" class="space-y-6">
                <div class="space-y-4">
                    <h2 class="text-xs font-black text-gray-400 uppercase px-2 tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-cyan-500 rounded-full"></span> Top Ingresos
                    </h2>
                    <div id="stats-inc-ref" class="space-y-3 bg-gray-800/40 p-4 rounded-xl border border-gray-800"></div>
                </div>

                <div class="space-y-4">
                    <h2 class="text-xs font-black text-gray-400 uppercase px-2 tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-pink-500 rounded-full"></span> Top Gastos
                    </h2>
                    <div id="stats-exp-ref" class="space-y-3 bg-gray-800/40 p-4 rounded-xl border border-gray-800"></div>
                </div>
            </div>

            <!-- DETALLE DE MOVIMIENTOS -->
            <div class="space-y-4">
                <h2 class="text-xs font-black text-gray-500 uppercase px-2 tracking-widest">Cronolog√≠a Detallada</h2>
                <div id="stats-details-list" class="space-y-2"></div>
            </div>
        </div>

    </main>

    <!-- Navegaci√≥n Inferior -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 px-6 py-3 z-50 shadow-2xl">
        <div class="max-w-md mx-auto flex justify-around items-center">
            <button onclick="switchTab('register')" id="tab-register" class="flex flex-col items-center gap-1 tab-active transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                <span class="text-[10px] font-bold">Registrar</span>
            </button>
            <button onclick="switchTab('stats')" id="tab-stats" class="flex flex-col items-center gap-1 text-gray-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span class="text-[10px] font-bold">Estad√≠sticas</span>
            </button>
        </div>
    </nav>

    <script>
        const googleAppsScriptURL = "https://script.google.com/macros/s/AKfycbxm-ykWsDdqHTzJW0OfjVAnROD-nTL0nhOyJc3xlelss8HzQuw0d2zIJKOw4XiUFDcQ9A/exec";

        let transactions = JSON.parse(localStorage.getItem('finanzas_v2')) || [];

        function switchTab(tab) {
            const reg = document.getElementById('view-register');
            const sta = document.getElementById('view-stats');
            const tReg = document.getElementById('tab-register');
            const tSta = document.getElementById('tab-stats');

            if (tab === 'register') {
                reg.classList.remove('hidden'); sta.classList.add('hidden');
                tReg.classList.add('tab-active'); tReg.classList.remove('text-gray-500');
                tSta.classList.add('text-gray-500'); tSta.classList.remove('tab-active');
                updateUI();
            } else {
                reg.classList.add('hidden'); sta.classList.remove('hidden');
                tSta.classList.add('tab-active'); tSta.classList.remove('text-gray-500');
                tReg.classList.add('text-gray-500'); tReg.classList.remove('tab-active');
                populateRefFilter();
                calculateStats();
            }
        }

        // Poblar el filtro de referencias bas√°ndose en los datos existentes
        function populateRefFilter() {
            const filterSelect = document.getElementById('filter-ref');
            const currentVal = filterSelect.value;
            const refs = [...new Set(transactions.map(t => t.referencia))].sort();
            
            filterSelect.innerHTML = '<option value="TODAS">üîç Todas las referencias</option>';
            refs.forEach(ref => {
                const opt = document.createElement('option');
                opt.value = ref;
                opt.textContent = ref;
                filterSelect.appendChild(opt);
            });
            filterSelect.value = currentVal; // Mantener selecci√≥n si existe
        }

        function updateUI() {
            const list = document.getElementById('transactions-list');
            list.innerHTML = '';
            const sorted = [...transactions].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            
            sorted.slice(0, 15).forEach((t) => {
                const originalIndex = transactions.indexOf(t);
                const isInc = t.concepto === 'Ingreso';
                const div = document.createElement('div');
                div.className = "card-bg p-3 rounded-xl border border-gray-800 flex justify-between items-center animate-fadeIn shadow-sm";
                div.innerHTML = `
                    <div class="text-sm">
                        <p class="font-bold text-gray-100">${t.referencia}</p>
                        <p class="text-[10px] text-gray-500">${t.fecha} ‚Ä¢ ${t.tipoMovimiento}</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <p class="${isInc ? 'text-custom-income':'text-custom-expense'} font-bold">
                            ${isInc ? '+':'-'}$${parseFloat(t.cantidad).toLocaleString()}
                        </p>
                        <button onclick="deleteItem(${originalIndex})" class="text-[10px] text-gray-600 hover:text-red-400 mt-1">Borrar</button>
                    </div>
                `;
                list.appendChild(div);
            });

            const income = transactions.filter(t => t.concepto === 'Ingreso').reduce((a, b) => a + parseFloat(b.cantidad), 0);
            const expense = transactions.filter(t => t.concepto === 'Gasto').reduce((a, b) => a + parseFloat(b.cantidad), 0);
            
            document.getElementById('total-ingresos').textContent = `$${income.toLocaleString()}`;
            document.getElementById('total-gastos').textContent = `$${expense.toLocaleString()}`;
            document.getElementById('diferencia').textContent = `$${(income - expense).toLocaleString()}`;
        }

        function renderBars(containerId, dataMap, colorClass) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const sortedEntries = Object.entries(dataMap).sort((a,b) => b[1] - a[1]);
            
            if (sortedEntries.length === 0) {
                container.innerHTML = '<p class="text-center text-[10px] text-gray-600 py-2">Sin datos registrados</p>';
                return;
            }

            const maxVal = sortedEntries[0][1];
            sortedEntries.forEach(([ref, val]) => {
                const perc = (val / maxVal) * 100;
                const row = document.createElement('div');
                row.className = "space-y-1 mb-2";
                row.innerHTML = `
                    <div class="flex justify-between text-[11px] px-1">
                        <span class="text-gray-300 font-semibold">${ref}</span>
                        <span class="text-gray-400 font-bold">$${val.toLocaleString()}</span>
                    </div>
                    <div class="w-full bg-gray-900/50 rounded-full h-1.5 overflow-hidden shadow-inner">
                        <div class="${colorClass} h-full rounded-full transition-all duration-1000" style="width: ${perc}%"></div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function calculateStats() {
            const desde = document.getElementById('stats-desde').value;
            const hasta = document.getElementById('stats-hasta').value;
            const filterRef = document.getElementById('filter-ref').value;
            
            let filtered = transactions;
            
            // Filtro por fecha
            if (desde) filtered = filtered.filter(t => t.fecha >= desde);
            if (hasta) filtered = filtered.filter(t => t.fecha <= hasta);
            
            // Filtro por referencia (NUEVO)
            if (filterRef !== "TODAS") {
                filtered = filtered.filter(t => t.referencia === filterRef);
                document.getElementById('ref-comparative-section').classList.add('hidden');
            } else {
                document.getElementById('ref-comparative-section').classList.remove('hidden');
            }

            const incTotal = filtered.filter(t => t.concepto === 'Ingreso').reduce((a, b) => a + parseFloat(b.cantidad), 0);
            const expTotal = filtered.filter(t => t.concepto === 'Gasto').reduce((a, b) => a + parseFloat(b.cantidad), 0);
            const neto = incTotal - expTotal;

            // UI Hero Balance
            const netCard = document.getElementById('net-card');
            const netAmount = document.getElementById('net-amount');
            const netIndicator = document.getElementById('net-indicator');
            
            netAmount.textContent = `$${neto.toLocaleString()}`;
            
            if (neto >= 0) {
                netCard.className = "p-6 rounded-2xl border border-emerald-500/50 bg-emerald-500/10 flex flex-col items-center justify-center space-y-2 shadow-[0_0_20px_rgba(16,185,129,0.1)]";
                netAmount.className = "text-4xl font-black text-emerald-400";
                netIndicator.textContent = "Balance Positivo";
                netIndicator.className = "text-[9px] px-3 py-1 rounded-full font-black uppercase bg-emerald-500 text-white shadow-lg";
            } else {
                netCard.className = "p-6 rounded-2xl border border-pink-500/50 bg-pink-500/10 flex flex-col items-center justify-center space-y-2 shadow-[0_0_20px_rgba(244,114,182,0.1)]";
                netAmount.className = "text-4xl font-black text-pink-400";
                netIndicator.textContent = "Balance Negativo";
                netIndicator.className = "text-[9px] px-3 py-1 rounded-full font-black uppercase bg-pink-500 text-white shadow-lg";
            }

            // Barra de flujo
            const totalFlujo = incTotal + expTotal;
            const percInc = totalFlujo > 0 ? (incTotal / totalFlujo) * 100 : 50;
            const percExp = totalFlujo > 0 ? (expTotal / totalFlujo) * 100 : 50;
            
            document.getElementById('bar-inc').style.width = `${percInc}%`;
            document.getElementById('bar-exp').style.width = `${percExp}%`;
            document.getElementById('hero-inc').textContent = `$${incTotal.toLocaleString()}`;
            document.getElementById('hero-exp').textContent = `$${expTotal.toLocaleString()}`;

            // Mapas de Referencia (Solo si vemos 'TODAS')
            if (filterRef === "TODAS") {
                const incMap = {}; const expMap = {};
                filtered.forEach(t => {
                    const val = parseFloat(t.cantidad);
                    if (t.concepto === 'Ingreso') incMap[t.referencia] = (incMap[t.referencia] || 0) + val;
                    else expMap[t.referencia] = (expMap[t.referencia] || 0) + val;
                });
                renderBars('stats-inc-ref', incMap, 'bg-cyan-500');
                renderBars('stats-exp-ref', expMap, 'bg-pink-500');
            }

            // Cronolog√≠a detallada
            const detailList = document.getElementById('stats-details-list');
            detailList.innerHTML = '';
            
            if (filtered.length === 0) {
                detailList.innerHTML = '<p class="text-center text-xs text-gray-600 py-10">No hay movimientos que coincidan con los filtros.</p>';
            } else {
                [...filtered].sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach(t => {
                    const isInc = t.concepto === 'Ingreso';
                    const card = document.createElement('div');
                    card.className = "bg-gray-800/60 p-3 rounded-lg border-l-4 " + (isInc ? 'border-cyan-500' : 'border-pink-500') + " shadow-sm";
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="text-xs">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-200">${t.referencia}</span>
                                    <span class="bg-gray-900 px-1.5 py-0.5 rounded text-[8px] text-gray-500 uppercase font-black">${t.tipoMovimiento}</span>
                                </div>
                                <p class="text-gray-500 mt-1">${t.fecha} ‚Ä¢ ${t.descripcion || 'Sin descripci√≥n'}</p>
                            </div>
                            <span class="font-bold ${isInc ? 'text-custom-income' : 'text-custom-expense'}">
                                ${isInc ? '+' : '-'}$${parseFloat(t.cantidad).toLocaleString()}
                            </span>
                        </div>
                    `;
                    detailList.appendChild(card);
                });
            }
        }

        window.deleteItem = (index) => {
            if(confirm("¬øEliminar del historial local?")) {
                transactions.splice(index, 1);
                localStorage.setItem('finanzas_v2', JSON.stringify(transactions));
                updateUI();
            }
        };

        window.clearAll = () => {
            if(confirm("¬øBorrar todo el historial local?")) {
                transactions = [];
                localStorage.setItem('finanzas_v2', JSON.stringify(transactions));
                updateUI();
            }
        };

        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const data = {
                fecha: document.getElementById('fecha').value,
                concepto: document.getElementById('concepto').value,
                referencia: document.getElementById('referencia').value,
                tipoMovimiento: document.getElementById('tipoMovimiento').value,
                descripcion: document.getElementById('descripcion').value,
                cantidad: document.getElementById('cantidad').value
            };

            transactions.push(data);
            localStorage.setItem('finanzas_v2', JSON.stringify(transactions));
            updateUI();

            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Sincronizando...';

            try {
                const params = new URLSearchParams();
                for(let k in data) params.append(k.toUpperCase(), data[k]);
                await fetch(googleAppsScriptURL, { method: 'POST', mode: 'no-cors', body: params });
                showToast("‚úÖ ¬°Guardado en Sheets!");
                e.target.reset();
                document.getElementById('fecha').valueAsDate = new Date();
            } catch (err) {
                showToast("‚ö†Ô∏è Error de red, guardado en local");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Guardar en Planilla</span>';
            }
        });

        function showToast(m) {
            const t = document.createElement('div');
            t.className = "fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl text-[10px] font-bold z-50 border border-gray-700 animate-bounce";
            t.textContent = m;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Inicio
        document.getElementById('fecha').valueAsDate = new Date();
        const now = new Date();
        document.getElementById('stats-desde').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('stats-hasta').value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        updateUI();
    </script>
</body>
</html>
